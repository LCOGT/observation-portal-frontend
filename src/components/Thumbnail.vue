<template>
  <div class="thumbnail-container">
    <span class="error" v-if="error">
      {{ error }}
    </span>
    <i class="fa fa-spinner fa-spin" v-show="!src && !error"></i>
    <img v-show="src" @click="generateLarge" class="thumbnail img-fluid img-thumbnail" :src="src" />
    <span v-show="loadLarge"><i class="fa fa-spin fa-spinner"></i> Generating high resolution image...</span>
  </div>
</template>
<script>
import $ from 'jquery';

export default {
  props: {
    frame: {},
    width: {
      default: 200,
    },
    height: {
      default: 200,
    },
  },
  data: function () {
    return {
      src: '',
      error: null,
      loadLarge: false,
    };
  },
  created: function () {
    this.updateFrame();
  },
  watch: {
    frame: function () {
      this.updateFrame();
    },
  },
  computed: {
    thumbnailServiceUrl: function () {
      return this.$store.state.urls.thumbnailService;
    },
    url: function () {
      return this.thumbnailServiceUrl + '/' + this.frame.id + '/?width=' + this.width + '&height=' + this.height + '&label=' + this.frame.filename;
    },
    largeUrl: function () {
      if (this.frame) {
        return this.thumbnailServiceUrl + '/' + this.frame.id + '/?width=4000&height=4000';
      } else {
        return '';
      }
    },
  },
  methods: {
    updateFrame: function () {
      if (this.frame) {
        this.src = '';
        this.fetch();
      }
    },
    fetch: function () {
      let that = this;
      $.getJSON(this.url, function (data) {
        that.src = data.url;
      }).fail(function () {
        that.error = 'Could not load thumbnail for this image';
      });
    },
    generateLarge: function () {
      let that = this;
      this.loadLarge = true;
      $.getJSON(this.largeUrl, function (data) {
        that.loadLarge = false;
        window.open(data['url'], '_blank');
      });
    },
  },
};
</script>
<style>
.thumbnail {
  cursor: pointer;
}
</style>
